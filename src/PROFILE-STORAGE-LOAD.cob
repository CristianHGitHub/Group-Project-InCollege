*> Profile Storage Loader (read-only)
IDENTIFICATION DIVISION.
PROGRAM-ID. PROFILE-STORAGE-LOAD.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT PROFILE-FILE ASSIGN TO "../data/ProfileRecords.txt"
        ORGANIZATION IS LINE SEQUENTIAL.

DATA DIVISION.
FILE SECTION.
FD PROFILE-FILE.
01 PROFILE-RECORD        PIC X(5000).

WORKING-STORAGE SECTION.
01 EXISTING-USER         PIC X(50).
01 PTR                   PIC 9(4) VALUE 1.
01 EOF-FLAG              PIC X VALUE "N".

LINKAGE SECTION.
01 L-USERNAME            PIC X(50).
01 L-PROFILE-DATA        PIC X(5000).

PROCEDURE DIVISION USING L-USERNAME L-PROFILE-DATA.
    MOVE SPACES TO L-PROFILE-DATA
    MOVE "N" TO EOF-FLAG

    OPEN INPUT PROFILE-FILE
    PERFORM UNTIL EOF-FLAG = "Y"
        READ PROFILE-FILE
            AT END
                MOVE "Y" TO EOF-FLAG
            NOT AT END
                MOVE 1 TO PTR
                UNSTRING PROFILE-RECORD DELIMITED BY "|"
                    INTO EXISTING-USER
                    WITH POINTER PTR
                END-UNSTRING

                IF FUNCTION TRIM(EXISTING-USER) = FUNCTION TRIM(L-USERNAME)
                    *> Copy everything after first "|" into profile data
                    MOVE PROFILE-RECORD(PTR:) TO L-PROFILE-DATA
                    MOVE "Y" TO EOF-FLAG
                END-IF
        END-READ
    END-PERFORM
    CLOSE PROFILE-FILE
    GOBACK.
