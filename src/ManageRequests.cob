IDENTIFICATION DIVISION.
PROGRAM-ID. MANAGEREQUESTS.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT PENDING-REQUEST-FILE ASSIGN TO "../data/ConnectionRecords.txt"
        ORGANIZATION IS LINE SEQUENTIAL
        FILE STATUS IS PENDING-STATUS.
    SELECT ESTABLISHED-FILE ASSIGN TO "../data/EstablishedConnections.txt"
        ORGANIZATION IS LINE SEQUENTIAL
        FILE STATUS IS EST-STATUS
        SHARING WITH ALL.

DATA DIVISION.
FILE SECTION.
FD  PENDING-REQUEST-FILE.
01  PR-RECORD.
    05 PR-SENDER        PIC X(40).
    05 PR-RECEIVER      PIC X(40).

FD  ESTABLISHED-FILE.
01  EST-RECORD.
    05 ER-USER-A        PIC X(40).
    05 ER-USER-B        PIC X(40).

WORKING-STORAGE SECTION.
01  PENDING-STATUS      PIC XX VALUE SPACES.
01  EST-STATUS          PIC XX VALUE SPACES.
01  PENDING-EOF         PIC X  VALUE "N".
01  EOF-FLAG            PIC X  VALUE "N".
01  MAX-PENDING         PIC 9(3) VALUE 100.
01  PENDING-FILE-COUNT  PIC 9(3) VALUE 0.
01  USER-PENDING-COUNT  PIC 9(3) VALUE 0.
01  TABLE-IDX           PIC 9(3) VALUE 0.
01  ACCEPT-INDEX        PIC 9(3) VALUE 0.
01  ACCEPT-SCAN-IDX     PIC 9(3) VALUE 0.
01  COMMAND-LEN         PIC 9(3) VALUE 0.
01  REMAINDER-LEN       PIC 9(3) VALUE 0.
01  PENDING-FILE-TABLE.
    05 PENDING-FILE-ENTRY OCCURS 100 TIMES.
        10 PF-SENDER    PIC X(40).
        10 PF-RECEIVER  PIC X(40).
01  USER-PENDING-TABLE.
    05 USER-PENDING-IDX OCCURS 100 TIMES PIC 9(3) VALUE 0.
01  WS-COMMAND-TRIM     PIC X(100).
01  WS-COMMAND-UPPER    PIC X(100).
01  WS-REMAINDER        PIC X(100).
01  WS-ACCEPT-USERNAME  PIC X(50).
01  WS-SENDER-TRIM      PIC X(50).
01  WS-RECEIVER-TRIM    PIC X(50).
01  WS-ERROR            PIC X VALUE "N".

LINKAGE SECTION.
01  L-USERNAME          PIC X(50).
01  L-COMMAND           PIC X(100).
01  L-NEEDS-COMMAND     PIC X.
01  L-STATUS            PIC X.
01  L-RESPONSE1         PIC X(200).
01  L-RESPONSE2         PIC X(200).

PROCEDURE DIVISION USING L-USERNAME L-COMMAND L-NEEDS-COMMAND
                           L-STATUS L-RESPONSE1 L-RESPONSE2.
    MOVE SPACES TO L-RESPONSE1 L-RESPONSE2
    MOVE "N"   TO L-NEEDS-COMMAND
    MOVE "N"   TO L-STATUS
    MOVE "N"   TO WS-ERROR

    PERFORM LOAD-PENDING-REQUESTS

    IF USER-PENDING-COUNT = 0
        GOBACK
    END-IF

    MOVE "Y" TO L-NEEDS-COMMAND

    MOVE L-COMMAND TO WS-COMMAND-TRIM
    MOVE FUNCTION TRIM(WS-COMMAND-TRIM) TO WS-COMMAND-TRIM
    MOVE FUNCTION TRIM(WS-COMMAND-TRIM LEADING) TO WS-COMMAND-TRIM

    IF WS-COMMAND-TRIM = SPACES
        MOVE "Enter 'Accept <username>' or 'Reject <username>' to manage requests, or 'Skip' to keep requests pending." TO L-RESPONSE1
        MOVE "P" TO L-STATUS
        GOBACK
    END-IF

    MOVE FUNCTION UPPER-CASE(WS-COMMAND-TRIM) TO WS-COMMAND-UPPER
    MOVE FUNCTION LENGTH(WS-COMMAND-TRIM) TO COMMAND-LEN

    IF WS-COMMAND-UPPER = "SKIP"
        MOVE "No connection requests were accepted." TO L-RESPONSE1
        MOVE "S" TO L-STATUS
        MOVE "N" TO L-NEEDS-COMMAND
        GOBACK
    END-IF

    IF COMMAND-LEN >= 6 AND WS-COMMAND-UPPER(1:6) = "ACCEPT"
        IF COMMAND-LEN = 6
            MOVE "Please specify which request to accept." TO L-RESPONSE1
            MOVE "E" TO L-STATUS
            MOVE "N" TO L-NEEDS-COMMAND
            GOBACK
        END-IF

        MOVE COMMAND-LEN TO REMAINDER-LEN
        SUBTRACT 6 FROM REMAINDER-LEN
        MOVE WS-COMMAND-TRIM(7:REMAINDER-LEN) TO WS-REMAINDER
        MOVE FUNCTION TRIM(WS-REMAINDER) TO WS-REMAINDER
        MOVE FUNCTION TRIM(WS-REMAINDER LEADING) TO WS-REMAINDER

        IF WS-REMAINDER = SPACES
            MOVE "Please specify which request to accept." TO L-RESPONSE1
            MOVE "E" TO L-STATUS
            MOVE "N" TO L-NEEDS-COMMAND
            GOBACK
        END-IF

        MOVE WS-REMAINDER TO WS-ACCEPT-USERNAME
        MOVE FUNCTION TRIM(WS-ACCEPT-USERNAME) TO WS-ACCEPT-USERNAME
        MOVE FUNCTION TRIM(WS-ACCEPT-USERNAME LEADING) TO WS-ACCEPT-USERNAME

        PERFORM FIND-REQUEST-BY-SENDER

        IF ACCEPT-INDEX = 0
            MOVE "No pending request from that user." TO L-RESPONSE1
            MOVE "E" TO L-STATUS
            MOVE "N" TO L-NEEDS-COMMAND
            GOBACK
        END-IF

        MOVE PF-SENDER(ACCEPT-INDEX)   TO WS-SENDER-TRIM
        MOVE PF-RECEIVER(ACCEPT-INDEX) TO WS-RECEIVER-TRIM
        MOVE FUNCTION TRIM(WS-SENDER-TRIM) TO WS-SENDER-TRIM
        MOVE FUNCTION TRIM(WS-SENDER-TRIM LEADING) TO WS-SENDER-TRIM
        MOVE FUNCTION TRIM(WS-RECEIVER-TRIM) TO WS-RECEIVER-TRIM
        MOVE FUNCTION TRIM(WS-RECEIVER-TRIM LEADING) TO WS-RECEIVER-TRIM

        PERFORM APPEND-TO-ESTABLISHED
        IF WS-ERROR = "Y"
            MOVE "Error: unable to record established connection." TO L-RESPONSE1
            MOVE "E" TO L-STATUS
            MOVE "N" TO L-NEEDS-COMMAND
            GOBACK
        END-IF

        PERFORM REWRITE-PENDING-FILE
        IF WS-ERROR = "Y"
            MOVE "Error: unable to update pending requests." TO L-RESPONSE1
            MOVE "E" TO L-STATUS
            MOVE "N" TO L-NEEDS-COMMAND
            GOBACK
        END-IF

        STRING "Connection request from "
               FUNCTION TRIM(WS-SENDER-TRIM)
               " accepted."
            DELIMITED BY SIZE
            INTO L-RESPONSE1
        END-STRING

        STRING "You are now connected with "
               FUNCTION TRIM(WS-SENDER-TRIM)
            DELIMITED BY SIZE
            INTO L-RESPONSE2
        END-STRING

        MOVE "A" TO L-STATUS
        MOVE "N" TO L-NEEDS-COMMAND
        GOBACK
    END-IF

    IF COMMAND-LEN >= 6 AND WS-COMMAND-UPPER(1:6) = "REJECT"
        IF COMMAND-LEN = 6
            MOVE "Please specify which request to reject." TO L-RESPONSE1
            MOVE "E" TO L-STATUS
            MOVE "N" TO L-NEEDS-COMMAND
            GOBACK
        END-IF

        MOVE COMMAND-LEN TO REMAINDER-LEN
        SUBTRACT 6 FROM REMAINDER-LEN
        MOVE WS-COMMAND-TRIM(7:REMAINDER-LEN) TO WS-REMAINDER
        MOVE FUNCTION TRIM(WS-REMAINDER) TO WS-REMAINDER
        MOVE FUNCTION TRIM(WS-REMAINDER LEADING) TO WS-REMAINDER

        IF WS-REMAINDER = SPACES
            MOVE "Please specify which request to reject." TO L-RESPONSE1
            MOVE "E" TO L-STATUS
            MOVE "N" TO L-NEEDS-COMMAND
            GOBACK
        END-IF

        MOVE WS-REMAINDER TO WS-ACCEPT-USERNAME
        MOVE FUNCTION TRIM(WS-ACCEPT-USERNAME) TO WS-ACCEPT-USERNAME
        MOVE FUNCTION TRIM(WS-ACCEPT-USERNAME LEADING) TO WS-ACCEPT-USERNAME

        PERFORM FIND-REQUEST-BY-SENDER

        IF ACCEPT-INDEX = 0
            MOVE "No pending request from that user." TO L-RESPONSE1
            MOVE "E" TO L-STATUS
            MOVE "N" TO L-NEEDS-COMMAND
            GOBACK
        END-IF

        MOVE PF-SENDER(ACCEPT-INDEX) TO WS-SENDER-TRIM
        MOVE FUNCTION TRIM(WS-SENDER-TRIM) TO WS-SENDER-TRIM
        MOVE FUNCTION TRIM(WS-SENDER-TRIM LEADING) TO WS-SENDER-TRIM

        PERFORM REWRITE-PENDING-FILE
        IF WS-ERROR = "Y"
            MOVE "Error: unable to update pending requests." TO L-RESPONSE1
            MOVE "E" TO L-STATUS
            MOVE "N" TO L-NEEDS-COMMAND
            GOBACK
        END-IF

        STRING "Connection request from "
               FUNCTION TRIM(WS-SENDER-TRIM)
               " rejected."
            DELIMITED BY SIZE
            INTO L-RESPONSE1
        END-STRING

        MOVE SPACES TO L-RESPONSE2
        MOVE "R" TO L-STATUS
        MOVE "N" TO L-NEEDS-COMMAND
        GOBACK
    END-IF

    MOVE "Invalid request action." TO L-RESPONSE1
    MOVE "E" TO L-STATUS
    MOVE "N" TO L-NEEDS-COMMAND
    GOBACK.

LOAD-PENDING-REQUESTS.
    MOVE 0 TO PENDING-FILE-COUNT USER-PENDING-COUNT
    MOVE "N" TO PENDING-EOF

    PERFORM VARYING TABLE-IDX FROM 1 BY 1 UNTIL TABLE-IDX > MAX-PENDING
        MOVE SPACES TO PF-SENDER(TABLE-IDX)
        MOVE SPACES TO PF-RECEIVER(TABLE-IDX)
        MOVE 0      TO USER-PENDING-IDX(TABLE-IDX)
    END-PERFORM

    OPEN INPUT PENDING-REQUEST-FILE
    IF PENDING-STATUS = "35"
        EXIT PARAGRAPH
    END-IF
    IF PENDING-STATUS NOT = "00"
        EXIT PARAGRAPH
    END-IF

    PERFORM UNTIL PENDING-EOF = "Y"
        READ PENDING-REQUEST-FILE
            AT END
                MOVE "Y" TO PENDING-EOF
            NOT AT END
                IF PENDING-FILE-COUNT < MAX-PENDING
                    ADD 1 TO PENDING-FILE-COUNT
                    MOVE PR-SENDER   TO PF-SENDER(PENDING-FILE-COUNT)
                    MOVE PR-RECEIVER TO PF-RECEIVER(PENDING-FILE-COUNT)

                    IF FUNCTION UPPER-CASE(
                           FUNCTION TRIM(PR-RECEIVER)) =
                       FUNCTION UPPER-CASE(
                           FUNCTION TRIM(L-USERNAME))
                        IF USER-PENDING-COUNT < MAX-PENDING
                            ADD 1 TO USER-PENDING-COUNT
                            MOVE PENDING-FILE-COUNT TO USER-PENDING-IDX(USER-PENDING-COUNT)
                        END-IF
                    END-IF
                END-IF
        END-READ
    END-PERFORM

    CLOSE PENDING-REQUEST-FILE
    MOVE "N" TO PENDING-EOF
    EXIT PARAGRAPH.

FIND-REQUEST-BY-SENDER.
    MOVE 0 TO ACCEPT-INDEX

    PERFORM VARYING ACCEPT-SCAN-IDX FROM 1 BY 1
        UNTIL ACCEPT-SCAN-IDX > USER-PENDING-COUNT OR ACCEPT-INDEX > 0
        MOVE USER-PENDING-IDX(ACCEPT-SCAN-IDX) TO ACCEPT-INDEX
        MOVE PF-SENDER(ACCEPT-INDEX) TO WS-SENDER-TRIM
        MOVE FUNCTION TRIM(WS-SENDER-TRIM) TO WS-SENDER-TRIM
        MOVE FUNCTION TRIM(WS-SENDER-TRIM LEADING) TO WS-SENDER-TRIM
        IF FUNCTION UPPER-CASE(WS-SENDER-TRIM) =
           FUNCTION UPPER-CASE(
               FUNCTION TRIM(WS-ACCEPT-USERNAME))
            EXIT PARAGRAPH
        END-IF
        MOVE 0 TO ACCEPT-INDEX
    END-PERFORM
    EXIT PARAGRAPH.

APPEND-TO-ESTABLISHED.
    MOVE "N" TO WS-ERROR

    OPEN EXTEND ESTABLISHED-FILE
    EVALUATE EST-STATUS
        WHEN "00"
            CONTINUE
        WHEN "35"
            *> If file is missing or not in a usable state for EXTEND,
            *> create/truncate it, then reopen in EXTEND mode
            OPEN OUTPUT ESTABLISHED-FILE
            IF EST-STATUS NOT = "00"
                MOVE "Y" TO WS-ERROR
            ELSE
                CLOSE ESTABLISHED-FILE
                OPEN EXTEND ESTABLISHED-FILE
                IF EST-STATUS NOT = "00"
                    MOVE "Y" TO WS-ERROR
                END-IF
            END-IF
        WHEN "61"
            *> If file is missing or not in a usable state for EXTEND,
            *> create/truncate it, then reopen in EXTEND mode
            OPEN OUTPUT ESTABLISHED-FILE
            IF EST-STATUS NOT = "00"
                MOVE "Y" TO WS-ERROR
            ELSE
                CLOSE ESTABLISHED-FILE
                OPEN EXTEND ESTABLISHED-FILE
                IF EST-STATUS NOT = "00"
                    MOVE "Y" TO WS-ERROR
                END-IF
            END-IF
        WHEN OTHER
            MOVE "Y" TO WS-ERROR
    END-EVALUATE

    IF WS-ERROR = "Y"
        EXIT PARAGRAPH
    END-IF

    MOVE PF-SENDER(ACCEPT-INDEX)   TO ER-USER-A
    MOVE PF-RECEIVER(ACCEPT-INDEX) TO ER-USER-B
    WRITE EST-RECORD
    CLOSE ESTABLISHED-FILE
    EXIT PARAGRAPH.

REWRITE-PENDING-FILE.
    MOVE "N" TO WS-ERROR

    OPEN OUTPUT PENDING-REQUEST-FILE
    IF PENDING-STATUS NOT = "00"
        MOVE "Y" TO WS-ERROR
        EXIT PARAGRAPH
    END-IF

    PERFORM VARYING TABLE-IDX FROM 1 BY 1 UNTIL TABLE-IDX > PENDING-FILE-COUNT
        IF TABLE-IDX NOT = ACCEPT-INDEX
            MOVE PF-SENDER(TABLE-IDX)   TO PR-SENDER
            MOVE PF-RECEIVER(TABLE-IDX) TO PR-RECEIVER
            WRITE PR-RECORD
        END-IF
    END-PERFORM

    CLOSE PENDING-REQUEST-FILE
    EXIT PARAGRAPH.

END PROGRAM MANAGEREQUESTS.
