*> Profile Storage Module (UPSERT)
IDENTIFICATION DIVISION.
PROGRAM-ID. PROFILE-STORAGE.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT PROFILE-FILE ASSIGN TO "../data/ProfileRecords.txt"
        ORGANIZATION IS LINE SEQUENTIAL.
    SELECT TMP-FILE     ASSIGN TO "../data/ProfileRecords.tmp"
        ORGANIZATION IS LINE SEQUENTIAL.

DATA DIVISION.
FILE SECTION.
FD PROFILE-FILE.
01 PROFILE-RECORD          PIC X(5000).

FD TMP-FILE.
01 TMP-RECORD              PIC X(5000).

WORKING-STORAGE SECTION.
01 NEW-RECORD              PIC X(5000).
01 EXISTING-USER           PIC X(50).
01 FOUND-FLAG              PIC X VALUE "N".
01 EOF-PROFILE             PIC X VALUE "N".
01 EOF-TMP                 PIC X VALUE "N".

LINKAGE SECTION.
01 L-USERNAME              PIC X(50).
01 L-PROFILE-DATA          PIC X(5000).
01 L-STATUS                PIC X.
01 L-RESPONSE              PIC X(100).

PROCEDURE DIVISION USING L-USERNAME L-PROFILE-DATA L-STATUS L-RESPONSE.
    MOVE "N" TO L-STATUS
    MOVE SPACES TO L-RESPONSE
    MOVE SPACES TO NEW-RECORD

    *> Build "username|profile-data"
    STRING
        FUNCTION TRIM(L-USERNAME) DELIMITED BY SIZE
        "|" DELIMITED BY SIZE
        FUNCTION TRIM(L-PROFILE-DATA) DELIMITED BY SIZE
        INTO NEW-RECORD
    END-STRING

    *> Step 1: copy/replace into temp
    OPEN INPUT PROFILE-FILE
    OPEN OUTPUT TMP-FILE
    MOVE "N" TO FOUND-FLAG
    MOVE "N" TO EOF-PROFILE

    PERFORM UNTIL EOF-PROFILE = "Y"
        READ PROFILE-FILE
            AT END
                MOVE "Y" TO EOF-PROFILE
            NOT AT END
                UNSTRING PROFILE-RECORD DELIMITED BY "|"
                    INTO EXISTING-USER
                END-UNSTRING

                IF FUNCTION TRIM(EXISTING-USER) = FUNCTION TRIM(L-USERNAME)
                    MOVE NEW-RECORD TO TMP-RECORD
                    WRITE TMP-RECORD
                    END-WRITE
                    MOVE "Y" TO FOUND-FLAG
                ELSE
                    MOVE PROFILE-RECORD TO TMP-RECORD
                    WRITE TMP-RECORD
                    END-WRITE
                END-IF
        END-READ
    END-PERFORM
    CLOSE PROFILE-FILE

    *> If not found, append new record
    IF FOUND-FLAG = "N"
        MOVE NEW-RECORD TO TMP-RECORD
        WRITE TMP-RECORD
                    END-WRITE
    END-IF
    CLOSE TMP-FILE

    *> Step 2: copy temp back to original
    OPEN OUTPUT PROFILE-FILE   *> truncate
    CLOSE PROFILE-FILE

    OPEN INPUT TMP-FILE
    OPEN OUTPUT PROFILE-FILE
    MOVE "N" TO EOF-TMP

    PERFORM UNTIL EOF-TMP = "Y"
        READ TMP-FILE
            AT END
                MOVE "Y" TO EOF-TMP
            NOT AT END
                MOVE TMP-RECORD TO PROFILE-RECORD
                WRITE PROFILE-RECORD
                END-WRITE
        END-READ
    END-PERFORM

    CLOSE TMP-FILE
    CLOSE PROFILE-FILE

    *> Clean up temp file
    DELETE FILE TMP-FILE

    MOVE "Y" TO L-STATUS
    MOVE "Profile saved successfully." TO L-RESPONSE
    GOBACK.
